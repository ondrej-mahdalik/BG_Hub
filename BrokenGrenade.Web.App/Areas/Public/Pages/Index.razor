@page "/"
@using BrokenGrenade.Web.BL.Facades
@using BrokenGrenade.Common.Models
@using BrokenGrenade.Common.Models.Filters
@using BrokenGrenade.Web.App.Resources
@using BrokenGrenade.Web.App.Resources.Areas.Public.Pages
@using Humanizer
@using Microsoft.Extensions.Localization
@inject MissionFacade MissionFacade
@inject TrainingFacade TrainingFacade
@inject PunishmentFacade PunishmentFacade
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<IndexResource> Localizer

<PageTitle>@Localizer[nameof(IndexResource.HubPageTitle)]</PageTitle>

<div class="row mt-4 flex-wrap">
<div class="col-12 col-lg-6 col-xxl-4 mb-4">
    <div class="card bg-dark-subtle">
        <div class="card-header">
            <h5 class="h6 card-title mb-0">@Localizer[nameof(IndexResource.TodaysMission)]</h5>
        </div>
        <div class="card-body">
            @if (_todaysMission is null)
            {
                <div class="row d-flex justify-content-center">
                    <div class="col-6 d-flex flex-column justify-content-center">
                        <p class="text-center fw-bold">@Localizer[nameof(IndexResource.NoMissionToday)]</p>
                        <img class="img-fluid p-4" alt="Sad Pepe" src="assets/img/sad_pepe.webp"/>
                    </div>
                </div>
            }
            else
            {
                <div class="row">
                    <div class="col col-sm-6">
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionName)]</h6>
                            <p>@_todaysMission.Name</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionAuthor)]</h6>
                            <p>@(_todaysMission.Creator?.Nickname ?? Localizer[nameof(SharedResources.DeletedUser)])</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionCategory)]</h6>
                            <p>@(_todaysMission.MissionType?.Name ?? Localizer[nameof(SharedResources.DeletedMissionCategory)])</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionModpack)]</h6>
                            <p>@(_todaysMission.ModpackType?.Name ?? Localizer[nameof(SharedResources.DeletedModpackType)])</p>
                        </div>
                    </div>
                    <div class="col col-sm-6">
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionLeaderBriefing)]</h6>
                            <p>@(_todaysMission.LeaderBriefingDate.HasValue ? _todaysMission.LeaderBriefingDate.Value.Humanize() : Localizer[nameof(IndexResource.NoLeaderBriefingPlanned)])</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionConnecting)]</h6>
                            <p>@_todaysMission.ConnectingToServerDate.Humanize()</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="card-subtitle text-primary">@Localizer[nameof(IndexResource.MissionStart)]</h6>
                            <p>@_todaysMission.MissionStartDate.Humanize()</p>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-auto">
                        @if (_todaysMission.ModpackUrl is null)
                        {
                            <span class="fc-not-allowed" tabindex="0" data-bs-toggle="tooltip" data-bs-title="@Localizer[nameof(IndexResource.NoCustomModpack)]">
                                <a class="btn btn-primary disabled" disabled>@Localizer[nameof(IndexResource.DownloadModpack)]</a>
                            </span>
                        }
                        else
                        {
                            <a class="btn btn-primary" href="@_todaysMission.ModpackUrl">@Localizer[nameof(IndexResource.DownloadModpack)]</a>
                        }
                    </div>
                    <div class="col-auto">
                        @if (_todaysMission.SlottingSheetUrl is null)
                        {
                            <span class="fc-not-allowed" tabindex="0" data-bs-toggle="tooltip" data-bs-title="@Localizer[nameof(IndexResource.SlottingNotProvided)]">
                                <a class="btn btn-primary disabled" disabled>@Localizer[nameof(SharedResources.Slotting)]</a>
                            </span>
                        }
                        else
                        {
                            <a class="btn btn-primary" href="@_todaysMission.SlottingSheetUrl">@Localizer[nameof(SharedResources.Slotting)]</a>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>
<div class="col-12 col-lg-6 col-xxl-4 mb-4">
    <div class="card bg-dark-subtle">
        <div class="card-header">
            <h5 class="h6 card-title mb-0">@Localizer[nameof(IndexResource.MissionsInUpcomingDays)]</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    @if (_upcomingMissions is null)
                    {
                        <table class="w-100">
                            <thead>
                            <tr>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionDate)]</th>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionName)]</th>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionAuthor)]</th>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionModpack)]</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <a tabindex="-1" class="btn btn-primary placeholder disabled col-12"></a>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <table class="w-100">
                            <thead>
                            <tr>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionDate)]</th>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionName)]</th>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionAuthor)]</th>
                                <th>@Localizer[nameof(IndexResource.UpcomingMissionModpack)]</th>
                                <th></th>
                            </tr>
                            </thead>
                            <tbody>
                            @if (_upcomingMissions.Count > 0)
                            {
                                @foreach (var mission in _upcomingMissions)
                                {
                                    <tr>
                                        <td>@mission.MissionStartDate</td>
                                        <td>@mission.Name</td>
                                        <td>@(mission.Creator?.Nickname ?? Localizer[nameof(SharedResources.DeletedUser)])</td>
                                        <td>@(mission.ModpackType?.Name ?? Localizer[nameof(SharedResources.DeletedModpackType)])</td>
                                        <td>
                                            <a class="btn btn-primary" href="/Mission/Detail/@mission.Id">@Localizer[nameof(IndexResource.UpcomingMissionDetail)]</a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5">
                                        <p class="text-center">@Localizer[nameof(IndexResource.NoUpcomingMissions)]</p>
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-12 col-lg-6 col-xxl-4 mb-4">
    <div class="card bg-dark-subtle">
        <div class="card-header">
            <h5 class="h6 card-title mb-0">@Localizer[nameof(IndexResource.UpcomingTrainings)]</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <table class="w-100">
                        <thead>
                        <tr>
                            <th>@Localizer[nameof(IndexResource.UpcomingTrainingDate)]</th>
                            <th>@Localizer[nameof(IndexResource.UpcomingTrainingName)]</th>
                            <th>@Localizer[nameof(IndexResource.UpcomingTrainingInstructor)]</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        @if (_upcomingTrainings is null)
                        {
                            <tr>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <a tabindex="-1" class="btn btn-primary placeholder disabled col-12"></a>
                                </td>
                            </tr>
                        }
                        else if (_upcomingTrainings.Count == 0)
                        {
                            <tr>
                                <td colspan="5">
                                    <p class="text-center">@Localizer[nameof(IndexResource.NoUpcomingTrainings)]</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var training in _upcomingTrainings)
                            {
                                <tr>
                                    <td>@training.Date</td>
                                    <td>@training.Name</td>
                                    <td>@(training.Creator?.Nickname ?? @Localizer[nameof(SharedResources.DeletedUser)])</td>
                                    <td>
                                        <a class="btn btn-primary" href="/Training/@training.Id">@Localizer[nameof(IndexResource.UpcomingTrainingDetail)]</a>
                                    </td>
                                </tr>
                            }
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="col-12 col-lg-6 col-xxl-4 mb-4">
    <div class="card bg-dark-subtle">
        <div class="card-header">
            <h5 class="h6 card-title mb-0">@Localizer[nameof(IndexResource.ActivePunishments)]</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <table class="w-100">
                        <thead>
                        <tr>
                            <th>@Localizer[nameof(IndexResource.PunishmentUser)]</th>
                            <th>@Localizer[nameof(IndexResource.PunishmentExpiration)]</th>
                            <th>@Localizer[nameof(IndexResource.PunishmentName)]</th>
                        </tr>
                        </thead>
                        <tbody>
                        @if (_activePunishments is null)
                        {
                            <tr>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                                <td>
                                    <p class="placeholder-glow">
                                        <span class="placeholder col-6"></span>
                                    </p>
                                </td>
                            </tr>
                        }
                        else if (_activePunishments.Count == 0)
                        {
                            <tr>
                                <td colspan="5">
                                    <p class="text-center">@Localizer[nameof(IndexResource.NoActivePunishments)]</p>
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var punishmentModel in _activePunishments)
                            {
                                <tr>
                                    <td>@punishmentModel.User?.Nickname</td>
                                    <td>@(punishmentModel.ExpiresOn.HasValue ? punishmentModel.ExpiresOn.Value : Localizer[nameof(IndexResource.NoExpirationDate)])</td>
                                    <td>@punishmentModel.Punishment</td>
                                </tr>
                            }
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

@code
{
    private MissionModel? _todaysMission;
    private List<MissionModel>? _upcomingMissions;
    private List<TrainingModel>? _upcomingTrainings;
    private List<PunishmentModel>? _activePunishments;

    protected override async Task OnInitializedAsync()
    {
        _upcomingMissions = await MissionFacade.GetUpcomingAsync(7);
        _upcomingTrainings = await TrainingFacade.GetUpcomingAsync();
        _activePunishments = await PunishmentFacade.GetActiveAsync();

        MissionFilterModel filter = new()
        {
            Date = DateTime.Today
        };
        _todaysMission = (await MissionFacade.GetAsync(filter)).FirstOrDefault();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JSRuntime.InvokeVoidAsync("InitTooltips");
    }
}